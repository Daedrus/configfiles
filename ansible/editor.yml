---
- name: Set up editor
  tags: editor
  block:
    - name: Install nvim build dependencies
      ansible.builtin.apt:
        name:
          - ninja-build
          - gettext
          - libtool
          - libtool-bin
          - autoconf
          - automake
          - cmake
          - g++
          - pkg-config
          - unzip
          - curl
          - doxygen
        update_cache: true
      tags:
        - editor_build_dependencies
    - name: Install nvim plugin dependencies
      ansible.builtin.apt:
        name:
          - ccls # C/C++ language server
        update_cache: true
      tags:
        - editor_plugin_dependencies
    - name: Clone nvim repo (get the stable version)
      become_user: "{{ username }}"
      ansible.builtin.git:
        repo: https://github.com/neovim/neovim.git
        dest: "/home/{{ username }}/.local/share/nvim/source/"
        clone: true
        version: stable
      tags:
        - editor_cloneneovim
    - name: Build nvim
      become_user: "{{ username }}"
      ansible.builtin.command:
        cmd: "make CMAKE_BUILD_TYPE=Release"
      args:
        chdir: "/home/{{ username }}/.local/share/nvim/source/"
      tags:
        - editor_buildneovim
    - name: Install nvim
      ansible.builtin.command:
        cmd: "make install"
      args:
        chdir: "/home/{{ username }}/.local/share/nvim/source/"
      tags:
        - editor_installneovim
    - name: Set nvim as the default editor
      community.general.alternatives:
        name: "{{ item }}"
        path: "/usr/local/bin/nvim"
      loop:
        - editor
        - vim
        - vi
      tags:
        - editor_default
    - name: Make sure directory structure is OK for vim-plug
      become_user: "{{ username }}"
      ansible.builtin.file:
        path: "/home/{{ username }}/.local/share/nvim/site/autoload"
        state: directory
        mode: '0755'
      tags:
        - editor_pluginmanagerdir
    - name: Install vim-plug
      become_user: "{{ username }}"
      ansible.builtin.get_url:
        url: "https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim"
        dest: "/home/{{ username }}/.local/share/nvim/site/autoload/"
      tags:
        - editor_pluginmanager
    - name: Create configuration folder
      become_user: "{{ username }}"
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "/home/{{ username }}/.config/nvim/"
      tags:
        - editor_configurationdir
    - name: Copy configuration file
      become_user: "{{ username }}"
      ansible.builtin.get_url:
        url: "{{ item.src }}"
        dest: "{{ item.dest }}"
      loop:
        - {src: "{{ configfilerepo }}/nvim/init.vim",
           dest: "/home/{{ username }}/.config/nvim/"}
      tags:
        - editor_configuration
    - name: Install plugins
      become_user: "{{ username }}"
      ansible.builtin.shell:
        cmd: nvim --headless +PlugInstall +qall
        creates: "/home/{{ username }}/.local/share/nvim/plugged"
      tags:
        - editor_installplugins
